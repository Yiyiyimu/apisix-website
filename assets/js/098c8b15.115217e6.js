(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{255:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var b=r.a.createContext({}),p=function(e){var t=r.a.useContext(b),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},s=function(e){var t=p(e.components);return r.a.createElement(b.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,b=c(e,["components","mdxType","originalType","parentName"]),s=p(n),d=a,h=s["".concat(l,".").concat(d)]||s[d]||u[d]||i;return n?r.a.createElement(h,o(o({ref:t},b),{},{components:n})):r.a.createElement(h,o({ref:t},b))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,l=new Array(i);l[0]=d;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var b=2;b<i;b++)l[b]=n[b];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},79:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return o})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return p}));var a=n(3),r=n(7),i=(n(0),n(255)),l={title:"openid-connect"},o={unversionedId:"plugins/openid-connect",id:"plugins/openid-connect",isDocsHomePage:!1,title:"openid-connect",description:"\x3c!--",source:"@site/docs/apisix/plugins/openid-connect.md",slug:"/plugins/openid-connect",permalink:"/docs/apisix/plugins/openid-connect",editUrl:"https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/openid-connect.md",version:"current",sidebar:"docs",previous:{title:"wolf-rbac",permalink:"/docs/apisix/plugins/wolf-rbac"},next:{title:"hmac-auth",permalink:"/docs/apisix/plugins/hmac-auth"}},c=[{value:"Summary",id:"summary",children:[]},{value:"Name",id:"name",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Modes of operation",id:"modes-of-operation",children:[{value:"Token Introspection",id:"token-introspection",children:[]},{value:"Introspecting with public key",id:"introspecting-with-public-key",children:[]}]},{value:"Troubleshooting",id:"troubleshooting",children:[]}],b={toc:c};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},b,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"summary"},"Summary"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#name"},Object(i.b)("strong",{parentName:"a"},"Name"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#attributes"},Object(i.b)("strong",{parentName:"a"},"Attributes"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#modes-of-operation"},Object(i.b)("strong",{parentName:"a"},"Modes of operation")),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#token-introspection"},Object(i.b)("strong",{parentName:"a"},"Token Introspection"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#introspecting-with-public-key"},Object(i.b)("strong",{parentName:"a"},"Introspecting with public key"))))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#troubleshooting"},Object(i.b)("strong",{parentName:"a"},"Troubleshooting")))),Object(i.b)("h2",{id:"name"},"Name"),Object(i.b)("p",null,"The OAuth 2 / Open ID Connect(OIDC) plugin provides authentication and introspection capability to APISIX."),Object(i.b)("h2",{id:"attributes"},"Attributes"),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",{parentName:"tr",align:null},"Name"),Object(i.b)("th",{parentName:"tr",align:null},"Type"),Object(i.b)("th",{parentName:"tr",align:null},"Requirement"),Object(i.b)("th",{parentName:"tr",align:null},"Default"),Object(i.b)("th",{parentName:"tr",align:null},"Valid"),Object(i.b)("th",{parentName:"tr",align:null},"Description"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"client_id"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"required"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"OAuth client ID")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"client_secret"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"required"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"OAuth client secret")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"discovery"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"required"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"URL of the discovery endpoint of the identity server")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"scope"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},'"openid"'),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Scope used for the authentication")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"realm"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},'"apisix"'),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Realm used for the authentication")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"bearer_only"),Object(i.b)("td",{parentName:"tr",align:null},"boolean"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"false"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Setting this ",Object(i.b)("inlineCode",{parentName:"td"},"true")," will check for the authorization header in the request with a bearer token")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"logout_path"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},'"/logout"'),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null})),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"redirect_uri"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},'"ngx.var.request_uri"'),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null})),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"timeout"),Object(i.b)("td",{parentName:"tr",align:null},"integer"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"3"),Object(i.b)("td",{parentName:"tr",align:null},"[1,...]"),Object(i.b)("td",{parentName:"tr",align:null},"Timeout in seconds")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"ssl_verify"),Object(i.b)("td",{parentName:"tr",align:null},"boolean"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"false"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null})),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"introspection_endpoint"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"URL of the token verification endpoint of the identity server")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"introspection_endpoint_auth_method"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},'"client_secret_basic"'),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Authentication method name for token introspection")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"public_key"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"The public key to verify the token")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"token_signing_alg_values_expected"),Object(i.b)("td",{parentName:"tr",align:null},"string"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Algorithm used to sign the token")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"set_access_token_header"),Object(i.b)("td",{parentName:"tr",align:null},"boolean"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"true"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Whether to ensure the access token is set in a request header.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"access_token_in_authorization_header"),Object(i.b)("td",{parentName:"tr",align:null},"boolean"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"false"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"If set to ",Object(i.b)("inlineCode",{parentName:"td"},"true"),", ensure that the access token is set in the ",Object(i.b)("inlineCode",{parentName:"td"},"Authorization")," header, otherwise use the ",Object(i.b)("inlineCode",{parentName:"td"},"X-Access-Token")," header.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"set_id_token_header"),Object(i.b)("td",{parentName:"tr",align:null},"boolean"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"true"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Whether to ensure the ID token, if available, is set in the ",Object(i.b)("inlineCode",{parentName:"td"},"X-ID-Token")," request header.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",{parentName:"tr",align:null},"set_userinfo_header"),Object(i.b)("td",{parentName:"tr",align:null},"boolean"),Object(i.b)("td",{parentName:"tr",align:null},"optional"),Object(i.b)("td",{parentName:"tr",align:null},"true"),Object(i.b)("td",{parentName:"tr",align:null}),Object(i.b)("td",{parentName:"tr",align:null},"Whether to ensure the UserInfo object, if available, is set in the ",Object(i.b)("inlineCode",{parentName:"td"},"X-Userinfo")," request header.")))),Object(i.b)("h2",{id:"modes-of-operation"},"Modes of operation"),Object(i.b)("p",null,"The plugin supports different modes of operation."),Object(i.b)("p",null,"1) It can be configured to just validate an access token that is expected to be present in a request header.\nIn this case, requests without a token or where the token is invalid are always rejected. This requires\n",Object(i.b)("inlineCode",{parentName:"p"},"bearer_only")," be set to ",Object(i.b)("inlineCode",{parentName:"p"},"true")," and that either an introspection endpoint has been configured through\n",Object(i.b)("inlineCode",{parentName:"p"},"introspection_endpoint"),", or that a public key has been configured through ",Object(i.b)("inlineCode",{parentName:"p"},"public_key"),". See the relevant\nsections below."),Object(i.b)("p",null,"2) Alternatively, the plugin can also be configured to authenticate a request without a valid token against\nan identity provider by going through the OIDC Authorization Code flow. The plugin then acts as an OIDC Relying Party.\nIn this scenario, when the requesting user has authenticated successfully, the plugin will obtain and manage\nan access token and further user claims on behalf of the user in a session cookie. Subsequent requests that\ncontain the cookie will use the access token stored in the cookie. In this case, ",Object(i.b)("inlineCode",{parentName:"p"},"bearer_only")," must be set to ",Object(i.b)("inlineCode",{parentName:"p"},"false"),"."),Object(i.b)("p",null,"The first option is typically appropriate for service-to-service communication where the requesting side can\nbe reasonably expected to obtain and manage a valid access token by itself. The second option is convenient\nto support web browser interaction with endpoints through a human user that may still need to be authenticated\nwhen accessing for the first time."),Object(i.b)("p",null,"The plugin can also be configured to support both scenarios by setting ",Object(i.b)("inlineCode",{parentName:"p"},"bearer_only")," to false, but still configuring\neither an introspection endpoint or a public key. In this case, introspection of an existing token from a request\nheader takes precedence over the Relying Party flow. That is, if a request contains an invalid token, the request\nwill be rejected without redirecting to the ID provider to obtain a valid token."),Object(i.b)("p",null,"The method used to authenticate a request also affects the headers that can be enforced on the request before\nsending it to upstream. The headers that can be enforced are mentioned below in each relevant section."),Object(i.b)("h3",{id:"token-introspection"},"Token Introspection"),Object(i.b)("p",null,"Token introspection helps to validate a request by verifying the token against an Oauth 2 authorization server.\nAs prerequisite, you should create a trusted client in the identity server and generate a valid token(JWT) for introspection.\nThe following image shows an example(successful) flow of the token introspection via the gateway."),Object(i.b)("p",null,Object(i.b)("img",{parentName:"p",src:"https://raw.githubusercontent.com/apache/apisix/master/docs/assets/images/plugin/oauth-1.png",alt:"token introspection"})),Object(i.b)("p",null,"The following is the curl command to enable the plugin to an external service.\nThis route will protect ",Object(i.b)("inlineCode",{parentName:"p"},"https://httpbin.org/get"),"(echo service) by introspecting the token provided in the header of the request."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},'curl http://127.0.0.1:9080/apisix/admin/routes/5 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n  "uri": "/get",\n  "plugins": {\n    "proxy-rewrite": {\n      "scheme": "https"\n    },\n    "openid-connect": {\n      "client_id": "api_six_client_id",\n      "client_secret": "client_secret_code",\n      "discovery": "full_URL_of_the_discovery_endpoint",\n      "introspection_endpoint": "full_URL_of_introspection_endpoint",\n      "bearer_only": true,\n      "realm": "master",\n      "introspection_endpoint_auth_method": "client_secret_basic"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:443": 1\n    }\n  }\n}\'\n')),Object(i.b)("p",null,"The following command can be used to access the new route."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},'curl -i -X GET http://127.0.0.1:9080/get -H "Host: httpbin.org" -H "Authorization: Bearer {replace_jwt_token}"\n')),Object(i.b)("p",null,"In this case, the plugin can enforce that the access token and the UserInfo object get set in respective configured request headers."),Object(i.b)("h3",{id:"introspecting-with-public-key"},"Introspecting with public key"),Object(i.b)("p",null,"You can also provide the public key of the JWT token to verify the token. In case if you have provided a public key and\na token introspection endpoint, the public key workflow will be executed instead of verifying with the identity server.\nThis method can be used if you want to reduce additional network calls and to speedup the process."),Object(i.b)("p",null,"The following configurations shows how to add a public key introspection to a route."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},'curl http://127.0.0.1:9080/apisix/admin/routes/5 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n  "uri": "/get",\n  "plugins": {\n    "proxy-rewrite": {\n      "scheme": "https"\n    },\n    "openid-connect": {\n      "client_id": "api_six_client_id",\n      "client_secret": "client_secret_code",\n      "discovery": "full_URL_of_the_discovery_endpoint",\n      "bearer_only": true,\n      "realm": "master",\n      "token_signing_alg_values_expected": "RS256",\n      "public_key" : "-----BEGIN CERTIFICATE-----\n        {public_key}\n        -----END CERTIFICATE-----"\n}\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:443": 1\n    }\n  }\n}\'\n')),Object(i.b)("p",null,"In this case, the plugin can only enforce that the access token gets set in the configured request headers."),Object(i.b)("h4",{id:"authentication-through-oidc-relying-party-flow"},"Authentication through OIDC Relying Party flow"),Object(i.b)("p",null,"When an incoming request does not contain an access token in a header, nor in an appropriate session cookie,\nthe plugin can act as an OIDC Relying Party and redirect to the authorization endpoint of the identity provider\nto go through the OIDC Authorization Code flow; see ",Object(i.b)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth"},"https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth"),".\nOnce the user has authenticated against the identity provider, the plugin will obtain and manage an access token\nand further information from the identity provider on behalf of the user. The information is currently stored\nin a session cookie that the user agent can submit on subsequent requests. The plugin will recognize the cookie\nand use the information therein to avoid having to go through the flow again."),Object(i.b)("p",null,"The following command adds this mode of operation to a route."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},'curl http://127.0.0.1:9080/apisix/admin/routes/5 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n  "uri": "/get",\n  "plugins": {\n    "proxy-rewrite": {\n      "scheme": "https"\n    },\n    "openid-connect": {\n      "client_id": "api_six_client_id",\n      "client_secret": "client_secret_code",\n      "discovery": "full_URL_of_the_discovery_endpoint",\n      "bearer_only": false,\n      "realm": "master"\n}\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:443": 1\n    }\n  }\n}\'\n')),Object(i.b)("p",null,"In this case, the plugin can enforce that the access token, the ID token, and the UserInfo object get set in respective configured request headers."),Object(i.b)("h2",{id:"troubleshooting"},"Troubleshooting"),Object(i.b)("p",null,"Check/modify the DNS settings (",Object(i.b)("inlineCode",{parentName:"p"},"conf/config.yaml"),") if APISIX cannot resolve/connect to the identity provider."))}p.isMDXComponent=!0}}]);